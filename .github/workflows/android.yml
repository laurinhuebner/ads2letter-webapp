name: Android APK

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # Alle ggf. vererbten JAVA_OPTS deaktivieren
      - name: Clear JAVA opts
        run: |
          echo "JAVA_TOOL_OPTIONS=" >> $GITHUB_ENV
          echo "_JAVA_OPTIONS=" >> $GITHUB_ENV

      # gradle.properties hart setzen (OHNE AnfÃ¼hrungszeichen!)
      - name: Write gradle.properties
        run: |
          cat > gradle.properties <<'EOF'
          org.gradle.jvmargs=-Xmx2g -Dfile.encoding=UTF-8
          org.gradle.warning.mode=all
          kotlin.compiler.execution.strategy=in-process
          kotlin.incremental.verbose=true
          android.useAndroidX=true
          EOF
          echo "=== gradle.properties ==="
          cat gradle.properties

      - name: Ensure Gradle wrapper
        run: |
          if [ ! -f ./gradlew ]; then
            echo "Gradle Wrapper fehlt. Erzeuge Wrapper..."
            mkdir -p gradle/wrapper
            # Minimaler Wrapper (falls dein Repo keinen hat):
            curl -sL https://raw.githubusercontent.com/gradle/gradle/master/gradle/wrapper/gradle-wrapper.properties -o gradle/wrapper/gradle-wrapper.properties || true
            curl -sL https://raw.githubusercontent.com/gradle/gradle/master/gradlew -o gradlew
            curl -sL https://raw.githubusercontent.com/gradle/gradle/master/gradlew.bat -o gradlew.bat
          fi
          chmod +x ./gradlew

      - name: Gradle -v
        run: ./gradlew -v

      - name: Build debug APK (with extra logs)
        run: |
          set -o pipefail
          ./gradlew clean :app:assembleDebug --stacktrace --info --warning-mode all | tee build.log

      - name: Upload APK
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          path: app/build/outputs/apk/debug/*.apk
          if-no-files-found: warn

      - name: Upload build logs & reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-and-reports
          path: |
            build.log
            **/build/reports/**
            **/build/outputs/logs/**
          if-no-files-found: warn
